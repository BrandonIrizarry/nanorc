local M = {}

local fixed = require "fixed"
local nonfixed = require "nonfixed"
local arith = require "arith"
local branching = require "branching"

function M.init ()
	local fn_name, filename
	local index = 0

	local function reset_function (name)
		fn_name = name
		index = 0
	end

	local function reset_filename (name)
		filename = name
		fn_name = "*anon"
	end

	local commands = {
		["push"] = {
			-- Commands for fixed segments
			["constant"] = fixed.push("constant"),
			["static"] = fixed.push("static", filename),
			["pointer"] = fixed.push("pointer"),
			["temp"] = fixed.push("temp"),

			-- Commands for nonfixed segments
			["local"] = nonfixed.push("local"),
			["argument"] = nonfixed.push("argument"),
			["this"] = nonfixed.push("this"),
			["that"] = nonfixed.push("that")
		},
		["pop"] = {
			-- Commands for fixed segments
			["static"] = fixed.pop("static", filename),
			["pointer"] = fixed.pop("pointer"),
			["temp"] = fixed.pop("temp"),

			-- Commands for nonfixed segments
			["local"] = nonfixed.pop("local"),
			["argument"] = nonfixed.pop("argument"),
			["this"] = nonfixed.pop("this"),
			["that"] = nonfixed.pop("that")
		},

		-- Arithmetic and logic commands
		["add"] = arith.commands["add"],
		["and"] = arith.commands["and"],
		["or"] = arith.commands["or"],
		["neg"] = arith.commands["neg"],
		["sub"] = arith.commands["sub"],
		["not"] = arith.commands["not"],

		-- Branching commands
		["label"] = branching.label(fn_name),
		["goto"] = branching["goto"](fn_name),
		["if-goto"] = branching["if-goto"](fn_name),

		-- Comparison commands
		["eq"] = arith.branch("eq")
		["gt"] = arith.branch("gt")
		["lt"] = arith.branch("lt")

		-- Function-call commands
		["function"] = fcall["function"](fn_name)
		["call"] = fcall["call"](fn_name)
		["return"] = fcall["return"](fn_name)
	}

	-- Ensure unique labels in stack comparison-operators
	local count = 0

	-- Comparison commands are deliberately absent from '_commands',
	-- so that they trigger this metatable
	--[[
	setmetatable(commands, {__index = function (_, cmd)
		local snippet = arith.branch(cmd, count)
		count = count + 1

		return snippet
	end})
	]]
	return {
		commands = commands,
		set_fn_name = set_fn_name
	}
end

return M
