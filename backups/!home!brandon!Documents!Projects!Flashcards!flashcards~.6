#!/usr/bin/env lua

local RANK = 1
local QUESTION = 2
local ANSWER = 3

local function query (msg, menu)
	if msg then
		io.write(msg)
	end

	io.write("[y/n]")

	repeat
		ans = io.read()
	until ans == "y" or ans == "n" or ans == " "

	return ans == "y" or ans == " "
end

local function ask (card)
	io.write("\n\n")

	io.write("\n")
	print(card[QUESTION])

	io.read(1) -- user presses "Enter" to continue

	print(card[ANSWER])

	io.write("\n")
	if query("Did you get this one?") then
		card[RANK] = card[RANK] + 1
	else
		card[RANK] = 0
	end
end

local function examine (card)
	print(string.format("rank=%d", card[RANK]))
	print(string.format("question=%s", card[QUESTION]))
	print(string.format("answer=%s", card[ANSWER]))
	print()
end

-- Usage: ./flashcards forth
if not arg[1] then
	print("Missing arg")
	os.exit()
end

local filename = string.format("cards/%s.lua", arg[1])
dofile(filename) -- loads the 'data' table

-- Run the question-answer session
for _, card in ipairs(data) do
	if data.day % math.tointeger(2^card[RANK]) == 0 then
		ask(card)
	end
end

-- Write everything back to the given file
local buffer = {
string.format([[
data={
	day=%s,]], data.day + 1)
}

for _, card in ipairs(data) do
	buffer[#buffer + 1] =
string.format([[
	{
		%d,
		%q,
		%q
	},]], card[RANK], card[QUESTION], card[ANSWER])
end

buffer[#buffer + 1] = "}"
buffer[#buffer + 1] = ""
local result = table.concat(buffer, "\n")

local file = io.open(filename, "w")
file:write(result)
file:close()
