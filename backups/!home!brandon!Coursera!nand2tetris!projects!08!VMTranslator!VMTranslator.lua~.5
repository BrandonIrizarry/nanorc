
-- Process a VM file
local file = assert(io.open(arg[1]))

local filename = arg[1]:gsub(".*/", "")
filename = filename:match("^[^%.]+")

local init = require("commands").init

local buffer = {}
for line in file:lines() do
	line = line:gsub("//.*", "")

	-- If line is empty, or all whitespace, skip
	if line:match("^%s*$") then
		goto continue
	end

	local maybe_fn_name = line:match("^function (.-)")
	local accessed = init(filename, fn_name)

	for token in line:gmatch("%w+") do
		accessed = accessed[token]
	end

	buffer[#buffer + 1] = accessed
	::continue::
end

local out_asm = assert(io.open(filename..".asm", "w"))

buffer[#buffer + 1] = ""
final_product = table.concat(buffer, "\n")
out_asm:write(final_product)

out_asm:close()
file:close()
