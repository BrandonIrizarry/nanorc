
local M = {}

function M.emit (command, filename, fn_name)
	if command == "push" or command == "pop" then
		local push_template = [[
// push *SEGMENT *ARG
@*REGISTER
D=*SOURCE
@SP
A=M
M=D
@SP
M=M+1]]
		local pop_template = [[
// pop *SEGMENT *ARG
@SP
M=M-1
A=M
D=M
@*REGISTER
M=D]]

		return function (segment)
			push_template:gsub("*SEGMENT", segment)
			pop_template:gsub("*SEGMENT", segment)

			local fixed = {pointer = true, constant = true, static = true, temp = true}
				if fixed[segment] then
					return function (arg)
						push_template:gsub("*ARG", arg)
						pop_template:gsub("*ARG", arg)
